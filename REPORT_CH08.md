
## 8장 . 헬스체크와 디펜던시 체크로 애플리케이션의 신뢰성 확보하기

## 학습 ##
- 운영 환경에서는 도커 스웜이나 쿠버네티스 같은 컨테이너 플랫폼상에서 어플리케이션을 실행하게 된다.
- 이들 플랫폼은 어플리케이션이 스스로 이상에서 회복 할 수 있도록 해주는 기능을 제공한다.(헬스체크)

- Dockerfile안에 HEALTHCHECK인스트럭션에서 컨테이너 런타임은 동작중인 어플리케이션의 상태를 알 수 있다.
  - 상태코드가 정상이면 컨테이너도 정상으로 간주하지만, 상태코드를 연속으로 인정횟수이상 실패시 이상상태로 간주하다.
  - 헬스체크가 실패해도 체크는 계속한다. 일시적인 체크 실패이였을수 잇기 때문에

- 분산 어플리케이션에서 컨테이터를 교체할때는 컨테이너간 의존관계를 생각해야한다.
- dependency 체크 기능도 도커 이미지에 추가 할 수있다. 실행시점은 헬슼체크와 족ㅁ 다른다
- 모든 요구사항이 확인되면 디펜던시 체크가 성공하고 어플리케이션이 실행된다.
  - 디펜던시체크가 안되면 어플리케이션 실행X
  - Dockerfile CMD 인스트럭션은 컨테이너 실행할때 실행된다
- 헬스 체크에도 CPU와 메모리를 필요하므로 운영 환경에서는 자운을 너무 많이 소모하지 않으면서, 어플리케이션이 실질적으로 동작중인지 검증 할 수 있는 핵심 적이 부분을 테스트 해야한다.
- 디펜던스 체크는 어플리케이션 실행시에만 실행된다. > 자원적인 문제는 크게 신경안써도 됨
  
# 어플리케이션 체크를 위한 커스텀 유틸리티 만들기
- 예제처럼 curl로 API를 테스트 하면 좋겟지만, 실무에서는 보안상 정책 이유로 curl이 없는 경우가 많다.
- 도커이미지에는 어플리케이션을 구동하는 최소한의 내용만 들어가야 하기때문에 사용하지 않은 도구는 최대한 배제해야한다.
- 따라서, 실제 어플리케이션 체크에는 어플리케이션과 같은 언어로 구성된 별도의 커스텀 유틸리티를 사용하는 것이 좋다.
  - 장점 1 ) 어플리케이션과 같은 언어를 사용하므로 이미지에 추가적 소프트웨어 포함 안시켜도 된다
  - 장점 2 ) 재시도 횟수나 분기등 쉘스크립트로 표현하기 까다로운 복잡한 체크로직 적용 가능
  - 장점 3 ) 어플리케이션과 같은 설정을 사용해 대상UIRL을 여러곳에 반복 정의 하거나 수정에서 누락 시키는 일 방지 가능
  - 장점 4 ) 어플리케이션과 같은 라이브러리 환경에서 DB접속, 인증파일의 유무등 컨테이너 실행전 확인이 필요한 모든 사항을 검증 할 수 있다.

# docker-compose.yml 헬스/디펜던스 체크 옵션
- healthcheck :
  - interval : 헬스체크 간격 
  - timeout : 실패로 간주하는 제한 시간
  - retries : 컨테이너 상태이상으로 간주할 연속된실패횟수
  - start_period : 컨테이너 실행후 첫 헬스 체크를 실시하는 시간 간격 
  
## 실습 ##
- Dockerfile에 헬스/디펜던스 체크 추가하기
- 헬스 체크 스크립트 :ch08/lab/src/memory-check.js 로 만들어 져있음
- 베이스 : ch08/lab/Dockerfile , ch08/lab/src/*

  CMD node memory-check.js && \
  node memory-hog.js

  HEALTHCHECK --interval=5s \
  CMD node memory-check.js
